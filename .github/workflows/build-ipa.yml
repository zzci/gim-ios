name: Build IPA

on:
  workflow_dispatch:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Unsigned IPA
    runs-on: macos-15

    permissions:
      contents: write

    env:
      SCHEME: ElementX
      ARCHIVE_PATH: build/ElementX.xcarchive

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_26.1.1.app

      - name: Install brew dependencies
        run: |
          unset HOMEBREW_NO_INSTALL_FROM_API
          export HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK=1
          brew update && brew install xcodegen pkl git-lfs

      - name: Generate Xcode project
        run: xcodegen

      - name: Resolve SPM dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -scheme "$SCHEME" \
            -clonedSourcePackagesDirPath "$RUNNER_TEMP/SourcePackages"

      - name: Archive (unsigned)
        run: |
          xcodebuild archive \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath "$ARCHIVE_PATH" \
            -clonedSourcePackagesDirPath "$RUNNER_TEMP/SourcePackages" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Package IPA
        run: |
          APP_PATH=$(find "$ARCHIVE_PATH/Products/Applications" -name "*.app" -maxdepth 1)
          mkdir -p build/Payload
          cp -R "$APP_PATH" build/Payload/
          cd build && zip -r -9 ElementX-unsigned.ipa Payload

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ElementX-unsigned.ipa
          path: build/ElementX-unsigned.ipa
          if-no-files-found: error

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: Build #${{ github.run_number }}
          body: |
            Unsigned IPA build from `${{ github.ref_name }}` @ `${{ github.sha }}`

            Re-sign with AltStore or Sideloadly to install on device.
          files: build/ElementX-unsigned.ipa
          make_latest: true
